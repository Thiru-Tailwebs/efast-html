<!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charging Locator</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Highcharts Maps -->
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/mapdata/countries/in/in-all.js"></script>
    <style>
      #india-map-container, #pincode-ui { min-height: 600px; }
      #india-map-container { width: 100%; }
      .marker-ongoing { color: #1e90ff; font-size: 1.5rem; }
      .marker-upcoming { color: #28a745; font-size: 1.5rem; }
      .state-top10 { fill: #2b8cbe !important; }
      .state-next10 { fill: #7bccc4 !important; }
      .state-rest { fill: #bae4bc !important; }
      .station-list { max-height: 550px; overflow-y: auto; }
      .station-item:hover { background: #f1f1f1; cursor: pointer; }
      .highlight-marker { border: 2px solid #ff9800 !important; }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <!-- Filters -->
      <div class="row mb-3 g-2">
        <div class="col-md-3">
          <select id="filter-state" class="form-select">
            <option value="">Select State</option>
            <!-- JS will populate -->
          </select>
        </div>
        <div class="col-md-3">
          <input id="filter-pincode" type="text" class="form-control" placeholder="Enter Pincode">
        </div>
        <div class="col-md-3">
          <select id="filter-type" class="form-select">
            <option>All Stations Type</option>
            <option>Direct Charging station</option>
            <option>Battery Swap station</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="filter-level" class="form-select">
            <option>Charging Level: Level 3 (Fast/DCFC)</option>
            <option>Level 2</option>
            <option>Level 1</option>
          </select>
        </div>
      </div>
      <!-- India Map -->
      <div id="india-map-container"></div>
      <!-- Pincode UI (hidden by default) -->
      <div id="pincode-ui" class="row mt-3 d-none">
        <div class="col-md-5">
          <div class="bg-white rounded p-3 shadow">
            <h5 id="pincode-location"></h5>
            <div id="station-list" class="station-list"></div>
          </div>
        </div>
        <div class="col-md-7">
          <div id="pincode-map" style="height: 550px;" class="rounded shadow"></div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Set your marker SVG/image paths here
      const stateMarkerImage = "assets/images/state-marker.svg";
      const stationMarkerOngoingImage = "assets/images/start-marker.svg";
      const stationMarkerUpcomingImage = "assets/images/green-marker.svg";

      // Dummy data for states and stations
      const statesData = [
        { code: 'IN-UP', name: 'Uttar Pradesh', ongoing: 120, upcoming: 80, lat: 27.0, lon: 80.0 },
        { code: 'IN-MH', name: 'Maharashtra', ongoing: 110, upcoming: 90, lat: 19.75, lon: 75.71 },
        { code: 'IN-TN', name: 'Tamil Nadu', ongoing: 100, upcoming: 70, lat: 11.1271, lon: 78.6569 },
        { code: 'IN-KA', name: 'Karnataka', ongoing: 95, upcoming: 60, lat: 15.3173, lon: 75.7139 },
        { code: 'IN-GJ', name: 'Gujarat', ongoing: 90, upcoming: 50, lat: 22.2587, lon: 71.1924 },
        { code: 'IN-RJ', name: 'Rajasthan', ongoing: 85, upcoming: 40, lat: 27.0238, lon: 74.2179 },
        { code: 'IN-WB', name: 'West Bengal', ongoing: 80, upcoming: 30, lat: 22.9868, lon: 87.8550 },
        { code: 'IN-MP', name: 'Madhya Pradesh', ongoing: 75, upcoming: 25, lat: 22.9734, lon: 78.6569 },
        { code: 'IN-TG', name: 'Telangana', ongoing: 70, upcoming: 20, lat: 18.1124, lon: 79.0193 },
        { code: 'IN-AP', name: 'Andhra Pradesh', ongoing: 65, upcoming: 15, lat: 15.9129, lon: 79.7400 },
        // Next 10
        { code: 'IN-OR', name: 'Odisha', ongoing: 60, upcoming: 10, lat: 20.9517, lon: 85.0985 },
        { code: 'IN-KL', name: 'Kerala', ongoing: 55, upcoming: 10, lat: 10.8505, lon: 76.2711 },
        { code: 'IN-JH', name: 'Jharkhand', ongoing: 50, upcoming: 10, lat: 23.6102, lon: 85.2799 },
        { code: 'IN-AS', name: 'Assam', ongoing: 45, upcoming: 10, lat: 26.2006, lon: 92.9376 },
        { code: 'IN-PB', name: 'Punjab', ongoing: 40, upcoming: 10, lat: 30.7333, lon: 76.7794 },
        { code: 'IN-CT', name: 'Chhattisgarh', ongoing: 35, upcoming: 10, lat: 21.2787, lon: 81.8661 },
        { code: 'IN-HR', name: 'Haryana', ongoing: 30, upcoming: 10, lat: 29.0588, lon: 76.0856 },
        { code: 'IN-JK', name: 'Jammu and Kashmir', ongoing: 25, upcoming: 10, lat: 33.7782, lon: 76.5762 },
        { code: 'IN-UT', name: 'Uttarakhand', ongoing: 20, upcoming: 10, lat: 30.3165, lon: 78.0322 },
        { code: 'IN-HP', name: 'Himachal Pradesh', ongoing: 15, upcoming: 10, lat: 31.1048, lon: 77.1734 },
        // Rest
        { code: 'IN-TR', name: 'Tripura', ongoing: 10, upcoming: 5, lat: 23.9408, lon: 91.9882 },
        { code: 'IN-ML', name: 'Meghalaya', ongoing: 8, upcoming: 3, lat: 25.467, lon: 91.3662 },
        { code: 'IN-MN', name: 'Manipur', ongoing: 7, upcoming: 2, lat: 24.8032, lon: 93.8363 },
        { code: 'IN-NL', name: 'Nagaland', ongoing: 6, upcoming: 2, lat: 26.1584, lon: 94.5624 },
        { code: 'IN-AR', name: 'Arunachal Pradesh', ongoing: 5, upcoming: 1, lat: 28.218, lon: 94.7278 },
        { code: 'IN-MZ', name: 'Mizoram', ongoing: 4, upcoming: 1, lat: 23.1645, lon: 92.9376 },
        { code: 'IN-SK', name: 'Sikkim', ongoing: 3, upcoming: 1, lat: 27.533, lon: 88.5122 },
        { code: 'IN-GA', name: 'Goa', ongoing: 2, upcoming: 1, lat: 15.2993, lon: 74.124 },
        { code: 'IN-DL', name: 'Delhi', ongoing: 1, upcoming: 1, lat: 28.6139, lon: 77.209 },
        { code: 'IN-PY', name: 'Puducherry', ongoing: 1, upcoming: 0, lat: 11.9416, lon: 79.8083 }
      ];

      // Generate dummy pincode data for any 6-digit pincode
      function getDummyPincodeData(pincode) {
        // Pick a state based on the pincode digits for deterministic results
        const stateIdx = parseInt(pincode.substr(0, 2), 10) % statesData.length;
        const state = statesData[stateIdx];
        // Generate a fake city name
        const city = state.name.split(' ')[0] + " City";
        // Generate 2-5 dummy stations near the state center
        const stationCount = 2 + (parseInt(pincode.substr(2, 1), 10) % 4);
        const stations = Array.from({length: stationCount}).map((_, i) => {
          const lat = state.lat + (Math.random() - 0.5) * 0.2;
          const lng = state.lon + (Math.random() - 0.5) * 0.2;
          return {
            name: `Station ${String.fromCharCode(65 + i)}`,
            type: i % 2 === 0 ? "Ongoing" : "Upcoming",
            address: `Address ${i+1}, ${city}, ${state.name}`,
            lat, lng
          };
        });
        return {
          place: city,
          state: state.name,
          lat: state.lat,
          lon: state.lon,
          stations
        };
      }

      // Populate state dropdown
        statesData.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.code.toLowerCase();  // Keep lowercase for consistency
          opt.textContent = s.name;
          document.getElementById('filter-state').appendChild(opt);
        });

      function getStateColorClass(idx) {
        if (idx < 10) return 'state-top10';
        if (idx < 20) return 'state-next10';
        return 'state-rest';
      }

      function getMapData() {
        return statesData.map((s, idx) => ({
          'hc-key': s.code.toLowerCase(),
          value: s.ongoing + s.upcoming,
          ongoing: s.ongoing,
          upcoming: s.upcoming,
          name: s.name,
          className: getStateColorClass(idx)
        }));
      }

      function getStateMarkers() {
        return statesData.map((s, idx) => ({
          lat: s.lat,
          lon: s.lon,
          name: s.name,
          ongoing: s.ongoing,
          upcoming: s.upcoming,
          idx
        }));
      }

      let chart;
      let stateMarkersSeries = null;
      let detailedMarkersSeries = [];

      function renderIndiaMap() {
        chart = Highcharts.mapChart('india-map-container', {
          chart: { map: 'countries/in/in-all', height: 600 },
          title: { text: '' },
          mapNavigation: { enabled: true, buttonOptions: { verticalAlign: 'bottom' } },
          legend: { enabled: false },
          tooltip: {
            useHTML: true,
            formatter: function () {
              if (this.point && this.point.name) {
                return `<b>${this.point.name}</b><br>
                  Ongoing Stations: <b>${this.point.ongoing}</b><br>
                  Upcoming Stations: <b>${this.point.upcoming}</b>`;
              }
              return '';
            }
          },
          series: [
            {
              data: getMapData(),
              joinBy: ['hc-key', 'hc-key'],
              name: 'States',
              states: { hover: { color: '#ffd54f' } },
              dataLabels: { enabled: false },
              allowPointSelect: true,
              className: '',
              events: {
                click: function (e) {
                  zoomToState(e.point['hc-key']);
                  // Set dropdown value to lowercase hc-key
                  document.getElementById('filter-state').value = e.point['hc-key'];
                }
              }
            },
            {
              type: 'mappoint',
              name: 'State Markers',
              color: '#000',
              data: getStateMarkers().map(m => ({
                lat: m.lat,
                lon: m.lon,
                name: m.name,
                ongoing: m.ongoing,
                upcoming: m.upcoming,
                marker: {
                  symbol: `url(${stateMarkerImage})`,
                  width: 38,
                  height: 38
                }
              })),
              dataLabels: { enabled: false },
              tooltip: {
                pointFormatter: function () {
                  return `<b>${this.name}</b><br>
                    Ongoing Stations: <b>${this.ongoing}</b><br>
                    Upcoming Stations: <b>${this.upcoming}</b>`;
                }
              }
            }
          ]
        });
        stateMarkersSeries = chart.series[1];
        detailedMarkersSeries = [];
        Highcharts.addEvent(chart.mapView, 'afterSetExtremes', resetMarkersOnZoom);
      }

      // Show detailed markers for a state, hide state markers
      function zoomToState(hcKey) {
        hcKey = hcKey.toLowerCase(); // Ensure lowercase for consistency
        console.log('Zooming to state:', hcKey); // Debug log
        const state = statesData.find(s => s.code.toLowerCase() === hcKey);
        if (!state) {
          console.log('State not found for hcKey:', hcKey); // Debug log
          return;
        }
        
        // Find the state polygon and fit tightly
        const feature = Highcharts.maps['countries/in/in-all'].features.find(
          f => (f.properties['hc-key'] || '').toLowerCase() === hcKey
        );
        if (feature && feature.geometry && feature.geometry.coordinates) {
          // Calculate bounds from all coordinates (support MultiPolygon and Polygon)
          let coords = [];
          if (feature.geometry.type === "Polygon") {
            coords = feature.geometry.coordinates[0];
          } else if (feature.geometry.type === "MultiPolygon") {
            coords = feature.geometry.coordinates.flat(2);
          }
          // Convert [lon, lat] to [lat, lon]
          const lats = coords.map(c => c[1]);
          const lons = coords.map(c => c[0]);
          const minLat = Math.min(...lats);
          const maxLat = Math.max(...lats);
          const minLon = Math.min(...lons);
          const maxLon = Math.max(...lons);
          chart.mapView.fitToBounds({
            x1: minLon,
            y1: minLat,
            x2: maxLon,
            y2: maxLat
          }, { padding: 0.5 }); // Very tight zoom
        } else if (feature && feature.bbox) {
          chart.mapView.fitToBounds({
            x1: feature.bbox[0],
            y1: feature.bbox[1],
            x2: feature.bbox[2],
            y2: feature.bbox[3]
          }, { padding: 0.5 });
        }
        
        // Remove previous detailed markers
        while (chart.series.length > 2) chart.series[2].remove();
        detailedMarkersSeries = [];
        // Hide state markers
        stateMarkersSeries.setVisible(false, false);

        // Add detailed markers for ongoing/upcoming (SVGs only)
        const ongoingData = Array.from({ length: Math.min(state.ongoing, 20) }).map(() => ({
          lat: state.lat + Math.random() * 1 - 0.5,
          lon: state.lon + Math.random() * 1 - 0.5,
          marker: {
            symbol: `url(${stationMarkerOngoingImage})`,
            width: 24,
            height: 31
          }
        }));
        const upcomingData = Array.from({ length: Math.min(state.upcoming, 20) }).map(() => ({
          lat: state.lat + Math.random() * 1 - 0.5,
          lon: state.lon + Math.random() * 1 - 0.5,
          marker: {
            symbol: `url(${stationMarkerUpcomingImage})`,
            width: 35,
            height: 46
          }
        }));

        if (ongoingData.length) {
          detailedMarkersSeries.push(chart.addSeries({
            type: 'mappoint',
            name: 'Ongoing Stations',
            color: '#1e90ff',
            data: ongoingData,
            dataLabels: { enabled: false },
            tooltip: { enabled: false }
          }, false));
        }
        if (upcomingData.length) {
          detailedMarkersSeries.push(chart.addSeries({
            type: 'mappoint',
            name: 'Upcoming Stations',
            color: '#28a745',
            data: upcomingData,
            dataLabels: { enabled: false },
            tooltip: { enabled: false }
          }, false));
        }
        chart.redraw();
      }

      // Reset to show state markers when zoomed out
      function resetMarkersOnZoom() {
        if (!chart) return;
        // If zoomed out enough, remove detailed markers and show state markers
        if (chart.mapView.zoom < 5) {
          while (chart.series.length > 2) chart.series[2].remove();
          stateMarkersSeries.setVisible(true, false);
          chart.redraw();
        }
      }

      // Filter: State dropdown
      document.getElementById('filter-state').addEventListener('change', function () {
        console.log('Dropdown changed to:', this.value); // Debug log
        if (this.value) {
          // Pass lowercase hc-key to zoomToState
          zoomToState(this.value);
        } else {
          // Reset to show all state markers and zoom out to full India
          while (chart.series.length > 2) chart.series[2].remove();
          stateMarkersSeries.setVisible(true, false);
          // Zoom out to full map
          if (chart && chart.mapView && chart.mapView.projection && chart.mapView.projection.bounds) {
            chart.mapView.fitToBounds(chart.mapView.projection.bounds, { padding: 0.1 });
          } else {
            chart.mapView.fitToBounds();
          }
          chart.redraw();
        }
      });

      // Filter: Pincode
      document.getElementById('filter-pincode').addEventListener('input', async function () {
        const val = this.value.trim();
        if (val.length === 6 && /^\d+$/.test(val)) {
          // Use Nominatim API to get real lat/lon for the pincode
          try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${val}&country=India&format=json&limit=1`);
            const data = await resp.json();
            if (data && data.length > 0) {
              const info = {
                place: data[0].display_name,
                state: data[0].address && data[0].address.state ? data[0].address.state : '',
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                stations: Array.from({length: 3}).map((_, i) => ({
                  name: `Station ${String.fromCharCode(65 + i)}`,
                  type: i % 2 === 0 ? "Ongoing" : "Upcoming",
                  address: `Address ${i+1}, ${data[0].display_name}`,
                  lat: parseFloat(data[0].lat) + (Math.random() - 0.5) * 0.01,
                  lng: parseFloat(data[0].lon) + (Math.random() - 0.5) * 0.01
                }))
              };
              document.getElementById('india-map-container').classList.add('d-none');
              document.getElementById('pincode-ui').classList.remove('d-none');
              document.getElementById('pincode-location').textContent = `${info.place} (${val})`;
              const list = document.getElementById('station-list');
              list.innerHTML = '';
              info.stations.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'station-item p-2 mb-2 rounded';
                div.innerHTML = `<span class="badge bg-${s.type === 'Ongoing' ? 'primary' : 'success'} me-2">${s.type} Station</span>
                  <b>${s.name}</b><br><small>${s.address}</small>`;
                div.dataset.idx = idx;
                div.id = `marker-${idx}`;
                div.addEventListener('mouseenter', () => highlightMarker(idx));
                div.addEventListener('mouseleave', () => highlightMarker(-1));
                list.appendChild(div);
              });
              renderPincodeMap(info);
            } else {
              // Not found
              document.getElementById('india-map-container').classList.remove('d-none');
              document.getElementById('pincode-ui').classList.add('d-none');
            }
          } catch (e) {
            document.getElementById('india-map-container').classList.remove('d-none');
            document.getElementById('pincode-ui').classList.add('d-none');
          }
        } else {
          document.getElementById('india-map-container').classList.remove('d-none');
          document.getElementById('pincode-ui').classList.add('d-none');
        }
      });

      // Render Leaflet map for pincode UI
      let leafletMap, leafletMarkers = [];
      function renderPincodeMap(info) {
        const mapDiv = document.getElementById('pincode-map');
        if (!leafletMap) {
          leafletMap = L.map(mapDiv).setView([info.lat, info.lon], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(leafletMap);
        } else {
          leafletMap.setView([info.lat, info.lon], 13);
          leafletMarkers.forEach(m => leafletMap.removeLayer(m));
          leafletMarkers = [];
        }
        info.stations.forEach((s, idx) => {
          const marker = L.marker([s.lat, s.lng], {
            icon: L.icon({
              iconUrl: s.type === "Ongoing" ? stationMarkerOngoingImage : stationMarkerUpcomingImage,
              iconSize: s.type === "Ongoing" ? [24, 31] : [35, 46],
              iconAnchor: s.type === "Ongoing" ? [12, 31] : [17, 46]
            })
          }).addTo(leafletMap)
            .bindPopup(`<b>${s.name}</b><br>${s.address}<br><span class="badge bg-${s.type === 'Ongoing' ? 'primary' : 'success'}">${s.type} Station</span>`);
          marker._customIdx = idx;
          leafletMarkers.push(marker);
        });
      }

      // Highlight marker on hover (Leaflet)
      function highlightMarker(idx) {
        // Highlight marker in station list
        leafletMarkers.forEach((m, i) => {
          if (i === idx) {
            m.openPopup();
            m.setZIndexOffset(1000);
          } else {
            m.closePopup();
            m.setZIndexOffset(0);
          }
        });
        // Highlight in list
        leafletMarkers.forEach((_, i) => {
          const markerDiv = document.getElementById(`marker-${i}`);
          if (markerDiv) markerDiv.classList.toggle('highlight-marker', i === idx);
        });
      }

      // Initial render
      renderIndiaMap();
    </script>
  </body>
  </html>